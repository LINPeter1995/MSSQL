` --	Module 6    02.Lab - Exception Handling.sql

--			ERROR_NUMBER() ?|??^???~?X?C
--			ERROR_SEVERITY() ?|??^?Y????C???d??0-24, ???Y????C(??p:0~9)?????~
--							????O???T???£YC????i?Y??????????~???????????B?z?????D
--			ERROR_STATE() ?|??^???~???A?X?C?i?H?z?L?????A?X????t???w?????D?????w?P?_
--							??O???????D?P??J?????~?O?_??P?A??K?B?z???~
--			ERROR_PROCEDURE() ?|??^?o????~???w?s?{?????o?{????W??C
--			ERROR_LINE() ?|??^?{?????B?w?s?{??B??o?{??£Z????y?????~???ÚH?C
--			ERROR_MESSAGE() ?|??^???~?T?????????r?C ??r?]?A?????????i???N??????A
--							??p?A????B????W??£X???C

use LabDB2
select * from NewTable;

--	?t?£Z??@@ERROR ?PERROR_NUMBER()???????t??
--			@@ERROR : ?P?_SQL Server?????~?o???????????????P?_?A??@@ERROR??0???????T????
--			ERROR_NUMBER():?£Z???o?bCATCH?????o????~?????~???X?A?bCATCH????~?I?s?|?^??NULL

begin tran
	Insert NewTable values(1, 'eeee');       -- error :  identitiy id
	print @@error			--  @@ error ???n????
	print @@error			--
	if @@error !=0
		begin
			print 'error happen'
			rollback tran
		end
	else 
		print 'commit'
		commit tran;

select @@trancount
select * from NewTable;
-----------------------------------------------------------------------

--  A. Using @@ERROR to ???? "?S?w?????~?N?X"
--  The following example uses @@ERROR to check for a check constraint violation (error #2627) in an UPDATE statement.

use LabDB2
select * from NewTable

Insert NewTable values(1, 'eeee'); 
if @@error = 2627
    begin
		print N'?H?? Primary Key ???????';
    end
-----------------------------------------------------------------------------

declare @TestTryCash int
begin try
		select @TestTryCash = 1000/0    -- error  /0
end try
begin catch
		if @@error !=0
			select	error_number()		as [error number],
						error_severity()		as [error severity], 
						error_state()				as [error state],
						error_procedure()	as [error procedure],
						error_line()				as [error line], 
						error_message()		as [error message]
		else
			print 'OK'
end catch
